# DLLStuff

This is the result of investigation that one of my colleagues asked me to look into.  

In essence can I create a utility that
* can accept an command message
* dynamically load a function from a DLL (both specified in the message)
* execute the function with parameters passed in the message.  
* can be containerised
* can be hosted on a number of container related platforms?

The answer to all the questions above is a resounding **YES**, but unfortunately the preferred container hosting platfrom is Azure Container Instances, and there is a little glitch there at the moment (that should be resolved very soon). 

This repo contains everything you need to get you own example up and running...

## Introduction

I haven't fully autmoated the deployment of this (I dont think enough people will want o try it to warrant that).  The remainder of this page should give you enough pointers to deploy it if you want to.

## Building the application

Clone/fork this repo and open the solution in Visual Studio (2019).  Ensure that the solution builds.

## Preparing to run locally

In your azure subscription:
* create a storage account with a container to hold inputs and results.  Note the connection string and container name
* create a service bus namespace and a queue within the namespace. Note the connection string and the queue name
* Add a file called local.settings.json in DLLStuff and ReqestCreator projects

`{
  "Logging": {
    "LogLevel": {
      "Default": "Warning"
    }
  },
  "StorageConnectionString": "",
  "ServiceBusConnectionString": "",
  "ServiceBusQueueName": "calculation-queue"`
  
*ensure this file is excluded from source control and copied to the output directory on build*

* In settings.json in the RequestCreator project configure the container name you created above
`{
  "ContainerName": "dllstuff"
}`

Upload the two native 32-bit DLLs (DLLStuff\dll?) that I developed for this exercise from your local drive to the container you created above.

* TurgidEagle.dll
* WiltedBeetroot.dll

The source code for these DLLs can be found [here](https://github.com/nikkh/TurgidEagle/tree/master/TurgidEagle) and [here](https://github.com/nikkh/WiltedBeetroot)

These are analagous to the model DLLs generated by modelling tools.  Note that the dependencies for the DLLs (ucrtbased.dll and vcruntime140d.dll) are stored in the root of the DLLStuff application and will be deployed along with it.

## Running locally

Change to the directory where the built RequestCreator.exe file is stored (DLLStuff\RequestCreator\bin\debug?) and run RequestCreator -h.  This will give you a description of the command:

This command will generate a single calculation request based on the supplied input parameters, and will generate a calculation request message. This will be placed on
  the configured service bus queue, which will then be picked up by the DLLStuff service and the requested calculation performed. Finally, the results will be written to
  the blob storage container specified in configuration. You can see the results in a blob called <requestid>.json. Request Id is written to the console on completion of
  the command.

![screenshot of the RequestCreator -h command output](docs/requestcreator-help.jpg)

Each time you run RequestCreator you supply parameters.  The combination of parameters you supply will lead tot he generation of a CalculationRequestMessage, which will be placed on the service bus queue and picked up by the processing engine.  The parameters are described briefly below:

--messageType <messagetype>      The type of message to send. Valid values are QuitMessage and CalculateMessage. If not supplied this will default to CalculateMessage
  
  --dllName <dllname>              The name of the DLL from which you wish to execute a function (DLL will be downloaded from blob storage)
  
  --functionName <functionname>    the name of the function your wish to execute
  
  --functionType <functiontype>    The type of function you wish to execute. Valid values are IntFunction or StringFunction. If you specify IntFunction you will need to supply a parameter which will be parsed as an integer
  
  --parameters <parameters>        A comma separated string of Int parameters. Must be supplied for IntFunction calls, ignored for StringFunctions.
  
Each DLL contains two functions.  They both contain a function that returns a string called get_library_name.  WiltedBeetroot contains a function called calculate_Cube which accepts and int and treturns the cube of the int.  TurgidEagle has a calculate_square function that returns the square of the inout.

The following commands will generate requests for each method in turn:

* RequestCreator --dllName WiltedBeetroot.dll --functionName calculate_cube --functionType IntFunction --parameters 4
* RequestCreator --dllName WiltedBeetroot.dll --functionName get_library_name --functionType StringFunction
* RequestCreator --dllName TurgidEagle.dll --functionName get_library_name --functionType StringFunction
* RequestCreator --dllName TurgidEagle.dll --functionName calculate_square --functionType IntFunction --parameters 9

If you now run the DLLStuff project, you should see your messages being processed:

![screenshot of DLLStuff output](docs/DLLStuff-output.jpg)
  
## Creating the Azure Infrastructure
## Creating a container
## Deploy to ACI
## Deploy to AKS
## Summary
